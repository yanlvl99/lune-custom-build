name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: lune.exe
            archive: lune-windows-x86_64.zip

          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: lune
            archive: lune-linux-x86_64.tar.gz

          - os: macos-14
            target: x86_64-apple-darwin
            artifact: lune
            archive: lune-macos-x86_64.tar.gz

          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: lune
            archive: lune-macos-aarch64.tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        run: cargo build --release --target ${{ matrix.target }} 2>&1

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "target/${{ matrix.target }}/release/${{ matrix.artifact }}" -DestinationPath "${{ matrix.archive }}" -Force

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          tar -czvf ../../../${{ matrix.archive }} ${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.archive }}
          path: ${{ matrix.archive }}

  msi:
    name: Build Windows MSI Installer
    runs-on: windows-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Windows build
        uses: actions/download-artifact@v4
        with:
          name: lune-windows-x86_64.zip
          path: installer_temp/

      - name: Prepare Files
        shell: pwsh
        run: |
          # Extrai o executável
          Expand-Archive -Path installer_temp/lune-windows-x86_64.zip -DestinationPath installer_temp/
          # Copia para a pasta installer
          Copy-Item installer_temp/lune.exe -Destination installer/lune.exe -Force
          # Copia o ícone se existir
          if (Test-Path "assets/logo/no-tilt.ico") {
            Copy-Item assets/logo/no-tilt.ico -Destination installer/lune.ico -Force
          }

      - name: Generate Assets (License & Images)
        shell: pwsh
        working-directory: installer
        run: |
          # === 1. CRIAR LICENÇA RTF (CLEAN) ===
          $rtfHeader = "{\rtf1\ansi\deff0\nouicompat{\fonttbl{\f0\fnil\fcharset0 Segoe UI;}}\viewkind4\uc1 \pard\sa200\sl276\slmult1\f0\fs20\lang22 "
          $licenseText = @"
          LUNE CUSTOM BUILD - END USER LICENSE AGREEMENT

          This software is licensed under the Mozilla Public License 2.0.

          1. Definitions
          1.1. "Contributor" means each individual or legal entity that creates, contributes to the creation of, or owns Covered Software.
          1.2. "Contributor Version" means the combination of the Contributions of others (if any) used by a Contributor and that particular Contributor's Contribution.

          (Standard MPL 2.0 Terms Apply - See https://mozilla.org/MPL/2.0/)
          "@
          $finalRtf = $rtfHeader + ($licenseText -replace "`n", "\par ") + "}"
          Set-Content "license.rtf" $finalRtf -Encoding ASCII

          # === 2. CRIAR IMAGENS (ROXO MINIMALISTA) ===
          Add-Type -AssemblyName System.Drawing
          $purple = [System.Drawing.Color]::FromArgb(255, 130, 80, 220)
          $brush = New-Object System.Drawing.SolidBrush($purple)

          # Banner (Topo)
          $banner = New-Object System.Drawing.Bitmap 493, 58
          $g = [System.Drawing.Graphics]::FromImage($banner)
          $g.Clear([System.Drawing.Color]::White)
          $g.FillRectangle($brush, 478, 0, 15, 58) # Faixa direita
          $g.FillRectangle($brush, 0, 56, 493, 2)  # Linha base
          $banner.Save("banner.bmp", [System.Drawing.Imaging.ImageFormat]::Bmp)
          $g.Dispose(); $banner.Dispose()

          # Dialog (Lateral)
          $dialog = New-Object System.Drawing.Bitmap 493, 312
          $g2 = [System.Drawing.Graphics]::FromImage($dialog)
          $g2.Clear([System.Drawing.Color]::White)
          $g2.FillRectangle($brush, 0, 0, 164, 312) # Barra lateral roxa
          $dialog.Save("dialog.bmp", [System.Drawing.Imaging.ImageFormat]::Bmp)
          $g2.Dispose(); $dialog.Dispose()

      - name: Install WiX Toolset
        run: dotnet tool install --global wix

      - name: Build MSI
        shell: pwsh
        working-directory: installer
        run: |
          # Adiciona extensões necessárias
          wix extension add WixToolset.UI.wixext --global
          wix extension add WixToolset.Util.wixext --global

          # Compila usando o lune.wxs que está no repositório
          wix build lune.wxs -o lune-installer.msi -ext WixToolset.UI.wixext -ext WixToolset.Util.wixext

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: lune-installer.msi
          path: installer/lune-installer.msi

  release:
    name: Create Release
    needs: [build, msi]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Lune Custom Build ${{ github.ref_name }}"
          body: |
            A standalone Luau runtime for backend and game-server development.

            ### Downloads

            | Platform | File |
            |----------|------|
            | **Windows Installer** | `lune-installer.msi` (recommended) |
            | Windows ZIP | `lune-windows-x86_64.zip` |
            | Linux | `lune-linux-x86_64.tar.gz` |
            | macOS Intel | `lune-macos-x86_64.tar.gz` |
            | macOS ARM | `lune-macos-aarch64.tar.gz` |

            ### Install with Rokit
            ```bash
            rokit add yanlvl99/lune-custom-build@${{ github.ref_name }}
            ```
          files: artifacts/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
